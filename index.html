<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Splitter (Custom Yellow Button)</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #2c3e50;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
            width: 95%;
            max-width: 900px;
        }
        h2 { margin-top: 0; color: #2c3e50; }

        /* Upload Area */
        .upload-area {
            border: 3px dashed #bdc3c7;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
            background-color: #ecf0f1;
        }
        .upload-area:hover {
            border-color: #3498db;
            background-color: #e8f6fc;
        }
        
        /* Result Area */
        #result-area {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
            word-break: break-all;
            text-align: left;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .info { background-color: #cff4fc; color: #055160; border: 1px solid #b6effb; }

        /* Control Panel Container */
        #control-panel {
            display: none;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            width: 100%;
        }

        /* Tool Group */
        .tool-group {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Download Group */
        .download-group {
            background: #e9ecef;
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 20px;
            display: flex;
            flex-direction: column; /* ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏î‡πà‡∏ô */
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 120px;
            text-align: center;
        }
        
        #pdf-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .page-card {
            position: relative;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            transition: 0.2s;
            width: 140px;
            background: white;
        }
        .page-card.selected {
            border-color: #28a745;
            background-color: #e9f7ef;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
        }
        .page-thumb {
            width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
        }
        .page-checkbox {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 10;
        }
        .page-label {
            font-size: 14px;
            padding: 5px;
            background: #f1f1f1;
            border-top: 1px solid #ddd;
        }

        /* --- Buttons Styling --- */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            color: white;
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn-primary { background-color: #3498db; }
        .btn-secondary { background-color: #7f8c8d; }

        /* ------------------------------------------------ */
        /* ‚òÖ CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‚òÖ */
        /* ------------------------------------------------ */
        .btn-yellow-custom {
            background-color: #ffff00; /* ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏™‡∏î */
            color: black;              /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏µ‡∏î‡∏≥ */
            border: 2px solid black;   /* ‡∏Ç‡∏≠‡∏ö‡∏î‡∏≥ */
            font-size: 24px;           /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡∏ç‡πà */
            padding: 5px 40px;         /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏° */
            cursor: pointer;
            font-family: sans-serif;
            text-transform: lowercase; /* ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å download */
            border-radius: 0px;        /* ‡πÑ‡∏°‡πà‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡∏°‡∏≤‡∏Å ‡∏ï‡∏≤‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏†‡∏≤‡∏û */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .btn-yellow-custom:hover {
            background-color: #e6e600; /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ */
        }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        .btn-split { 
            background-color: #28a745; 
            font-size: 16px;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            border: none;
        }
        .btn-split:hover { background-color: #218838; }

        #current-file-label {
            margin-top: 10px;
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }

    </style>
</head>
<body>

    <div class="container">
        <h2>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô All-in-One + ‡∏ï‡∏±‡∏î‡∏ï‡πà‡∏≠ PDF</h2>
        
        <div class="upload-area" id="drop-zone" onclick="document.getElementById('file-input').click()">
            <p>üìÇ <b>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</b> (PDF / ‡∏£‡∏π‡∏õ QR Code)<br>‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Ctrl+V ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á</p>
        </div>
        <input type="file" id="file-input" accept="image/*,application/pdf" style="display: none;">

        <div id="result-area"></div>
        <div id="current-file-label"></div>

        <div id="control-panel">
            
            <div class="tool-group">
                <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤:</span>
                <input type="text" id="page-range" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1-3, 5">
                <button class="btn btn-primary" onclick="applyPageRange()">‚úì ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                <button class="btn btn-secondary" onclick="selectAll(true)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="btn btn-secondary" onclick="selectAll(false)">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>

            <div class="download-group">
                <button class="btn-yellow-custom" onclick="downloadCurrentFile()">
                    download
                </button>

                <p style="margin:0; font-size:12px; color:#666;">‡∏´‡∏£‡∏∑‡∏≠</p>

                <button class="btn-split" onclick="splitAndDownload()">
                    ‚úÇÔ∏è ‡∏ï‡∏±‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å & ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                </button>
            </div>

        </div>

        <div id="pdf-preview"></div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        const { PDFDocument } = PDFLib;

        const html5QrCode = new Html5Qrcode("drop-zone");
        const resultArea = document.getElementById('result-area');
        const pdfPreview = document.getElementById('pdf-preview');
        const controlPanel = document.getElementById('control-panel');
        const currentFileLabel = document.getElementById('current-file-label');
        
        let currentPdfBytes = null; 
        let totalPages = 0;
        let currentFileName = "document.pdf"; 

        // --- 1. ‡∏™‡πÅ‡∏Å‡∏ô QR Code ---
        const scanImageFile = (imageFile) => {
            showStatus("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô QR Code...", "loading");
            html5QrCode.scanFileV2(imageFile, true)
            .then(decodedResult => {
                const text = decodedResult.decodedText;
                try {
                    new URL(text);
                    showStatus(`‚úÖ <b>‡πÄ‡∏à‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå:</b> ${text}<br>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå...`, "loading");
                    
                    currentFileName = text.substring(text.lastIndexOf('/') + 1) || "qr-download.pdf";
                    if(!currentFileName.endsWith('.pdf')) currentFileName += ".pdf";

                    fetch(text)
                        .then(res => { if (!res.ok) throw new Error("Network error"); return res.arrayBuffer(); })
                        .then(buffer => {
                            renderPdfFromBytes(buffer, currentFileName); 
                            showStatus(`‚úÖ <b>‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</b>`, "success");
                        })
                        .catch(err => {
                            showStatus(`‚ö†Ô∏è <b>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ï‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå):</b> <a href="${text}" target="_blank">${text}</a>`, "error");
                        });
                } catch (e) {
                    showStatus(`‚úÖ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: <b>${text}</b>`, "success");
                }
            })
            .catch(err => showStatus("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö QR Code", "error"));
        };

        // --- 2. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• PDF ---
        const renderPdfFromBytes = async (arrayBuffer, fileName) => {
            currentPdfBytes = arrayBuffer;
            currentFileName = fileName;
            
            currentFileLabel.innerHTML = `üìÑ ‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span style="color:#000; font-weight:bold;">${currentFileName}</span>`;
            pdfPreview.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• PDF...";
            controlPanel.style.display = 'none';

            try {
                const loadingTask = pdfjsLib.getDocument(arrayBuffer);
                const pdf = await loadingTask.promise;
                totalPages = pdf.numPages;

                pdfPreview.innerHTML = "";
                controlPanel.style.display = 'flex'; 
                resultArea.style.display = 'none'; 

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 0.5 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({ canvasContext: context, viewport: viewport }).promise;

                    const card = document.createElement('div');
                    card.className = 'page-card';
                    card.dataset.pageNum = i;
                    
                    card.onclick = (e) => {
                        if (e.target.type !== 'checkbox') {
                            const cb = card.querySelector('.page-checkbox');
                            cb.checked = !cb.checked;
                            toggleSelectionStyle(card, cb.checked);
                        }
                    };

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'page-checkbox';
                    checkbox.value = i;
                    checkbox.onchange = () => toggleSelectionStyle(card, checkbox.checked);

                    const img = document.createElement('img');
                    img.src = canvas.toDataURL();
                    img.className = 'page-thumb';

                    const label = document.createElement('div');
                    label.className = 'page-label';
                    label.innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${i}`;

                    card.appendChild(checkbox);
                    card.appendChild(img);
                    card.appendChild(label);
                    pdfPreview.appendChild(card);
                }
            } catch (error) {
                console.error(error);
                showStatus("‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "error");
            }
        };

        const handlePdfFile = async (file) => {
            if (file.name) currentFileName = file.name;
            const buffer = await file.arrayBuffer();
            renderPdfFromBytes(buffer, currentFileName);
        };

        function showStatus(msg, type) {
            resultArea.style.display = 'block';
            resultArea.className = type;
            resultArea.innerHTML = msg;
        }

        function toggleSelectionStyle(card, isChecked) {
            if (isChecked) card.classList.add('selected');
            else card.classList.remove('selected');
        }

        // --- Selection Logic ---
        function applyPageRange() {
            const input = document.getElementById('page-range').value;
            selectAll(false);
            const parts = input.split(',');
            parts.forEach(part => {
                part = part.trim();
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(Number);
                    for (let i = start; i <= end; i++) checkPage(i);
                } else {
                    checkPage(Number(part));
                }
            });
        }

        function checkPage(pageNum) {
            const card = document.querySelector(`.page-card[data-page-num="${pageNum}"]`);
            if (card) {
                const cb = card.querySelector('.page-checkbox');
                cb.checked = true;
                toggleSelectionStyle(card, true);
            }
        }

        function selectAll(select) {
            document.querySelectorAll('.page-checkbox').forEach(cb => {
                cb.checked = select;
                toggleSelectionStyle(cb.parentElement, select);
            });
        }

        // --- Download Functions ---
        
        // 1. ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function downloadCurrentFile() {
            if (!currentPdfBytes) {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");
                return;
            }
            const blob = new Blob([currentPdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = currentFileName; 
            link.click();
        }

        // 2. ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß: ‡∏ï‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        async function splitAndDownload() {
            const checkboxes = document.querySelectorAll('.page-checkbox:checked');
            if (checkboxes.length === 0) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡πÑ‡∏ü‡∏•‡πå");
                return;
            }
            
            try {
                showStatus("‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î‡πÑ‡∏ü‡∏•‡πå...", "loading");

                const pageNumbers = Array.from(checkboxes).map(cb => parseInt(cb.value));
                const pdfDoc = await PDFDocument.load(currentPdfBytes);
                const newPdf = await PDFDocument.create();
                
                const pagesToCopy = pageNumbers.map(n => n - 1);
                const copiedPages = await newPdf.copyPages(pdfDoc, pagesToCopy);
                copiedPages.forEach(page => newPdf.addPage(page));

                let originalName = currentFileName.replace(/\.[^/.]+$/, ""); 
                let pageStr = pageNumbers.join(' '); 
                if(pageNumbers.length === totalPages) pageStr = "ALL";
                let newFileName = `${originalName}_page_${pageStr}.pdf`;

                const pdfBytes = await newPdf.save();

                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = newFileName;
                link.click(); 

                await renderPdfFromBytes(pdfBytes, newFileName);
                
                showStatus(`‚úÖ <b>‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</b> ‡∏ï‡∏±‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô <b>${newFileName}</b> ‡πÅ‡∏•‡πâ‡∏ß`, "info");
                document.getElementById('page-range').value = '';

            } catch (err) {
                console.error(err);
                showStatus("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF", "error");
            }
        }

        const handleFile = (file) => {
            if (!file) return;
            if (file.type === "application/pdf") {
                handlePdfFile(file);
            } else {
                scanImageFile(file);
            }
        };

        document.getElementById('file-input').addEventListener('change', e => handleFile(e.target.files[0]));
        document.addEventListener('paste', e => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) {
                if (item.kind === 'file') handleFile(item.getAsFile());
            }
        });
    </script>
</body>
</html>
